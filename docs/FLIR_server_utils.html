---

title: Flir Camera Server

keywords: fastai
sidebar: home_sidebar

summary: "Utilities for running a multi camera server"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/92_FLIR_server_utils.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="CameraThread" class="doc_header"><code>class</code> <code>CameraThread</code><a href="https://github.com/johnnewto/FLIR_pubsub/tree/master/FLIR_pubsub/FLIR_server_utils.py#L27" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>CameraThread</code>(<strong><code>socket_pub</code></strong>, <strong><code>i</code></strong>, <strong><code>yaml_dict</code></strong>)</p>
</blockquote>
<p>Each camera is controlled by a separate thread, allowing it to be started stopped.
When started the update loop will wait for a cammera image and send it the  array data through a zmq socket.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="CameraThread.start" class="doc_header"><code>CameraThread.start</code><a href="https://github.com/johnnewto/FLIR_pubsub/tree/master/FLIR_pubsub/FLIR_server_utils.py#L53" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>CameraThread.start</code>()</p>
</blockquote>
<p>Initialise and set camera thread and begin acquisition</p>

</div>

</div>

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="CameraThread.stop" class="doc_header"><code>CameraThread.stop</code><a href="https://github.com/johnnewto/FLIR_pubsub/tree/master/FLIR_pubsub/FLIR_server_utils.py#L63" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>CameraThread.stop</code>()</p>
</blockquote>
<p>indicate that the thread should be stopped</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="GPIOThread" class="doc_header"><code>class</code> <code>GPIOThread</code><a href="https://github.com/johnnewto/FLIR_pubsub/tree/master/FLIR_pubsub/FLIR_server_utils.py#L118" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>GPIOThread</code>(<strong><code>pin_no</code></strong>, <strong><code>freq</code></strong>=<em><code>2.0</code></em>)</p>
</blockquote>
<p>A thread class to control and toggle Upboard GPIO pins, allowing it to be started &amp; stopped.
Pin number and frequncy can be set</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="GPIOThread.start" class="doc_header"><code>GPIOThread.start</code><a href="https://github.com/johnnewto/FLIR_pubsub/tree/master/FLIR_pubsub/FLIR_server_utils.py#L132" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>GPIOThread.start</code>()</p>
</blockquote>
<p>Start the pin toggle</p>

</div>

</div>

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="GPIOThread.stop" class="doc_header"><code>GPIOThread.stop</code><a href="https://github.com/johnnewto/FLIR_pubsub/tree/master/FLIR_pubsub/FLIR_server_utils.py#L140" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>GPIOThread.stop</code>()</p>
</blockquote>
<p>Stop the pin toggle</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="register" class="doc_header"><code>register</code><a href="https://github.com/johnnewto/FLIR_pubsub/tree/master/FLIR_pubsub/FLIR_server_utils.py#L166" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>register</code>()</p>
</blockquote>
<p>Run multi_pyspin constructor and register multi_pyspin destructor. Should be called once when first imported</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="server" class="doc_header"><code>server</code><a href="https://github.com/johnnewto/FLIR_pubsub/tree/master/FLIR_pubsub/FLIR_server_utils.py#L170" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>server</code>(<strong><code>yaml_dir</code></strong>)</p>
</blockquote>
<p>Main loop for the server. Polls and sets up the cameras. Sets up the socket and port numbers and starts threads.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Examples">Examples<a class="anchor-link" href="#Examples">&#182;</a></h2><h3 id="Example-of-a-Multiple-Camera-Server">Example of a Multiple Camera Server<a class="anchor-link" href="#Example-of-a-Multiple-Camera-Server">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span>  <span class="nn">FLIR_pubsub</span> <span class="kn">import</span> <span class="n">FLIR_server_utils</span>
<span class="n">FLIR_server_utils</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>  

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">yaml_dir</span><span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">/</span><span class="s1">&#39;common&#39;</span>
    <span class="n">FLIR_server_utils</span><span class="o">.</span><span class="n">server</span><span class="p">(</span><span class="n">yaml_dir</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>19444712 - connected
19444715 - connected
/home/john/github/FLIR_pubsub/nbs/common/19444712.yaml
19444712 - setting up...
19444712 - executing: &#34;UserSetSelector.SetValue(PySpin.UserSetDefault_Default)&#34;
19444712 - executing: &#34;UserSetLoad.Execute()&#34;
19444712 - executing: &#34;LineSelector.SetValue(PySpin.LineSelector_Line2)&#34;
19444712 - executing: &#34;V3_3Enable.SetValue(True)&#34;
19444712 - executing: &#34;AcquisitionFrameRateEnable.SetValue(False)&#34;
19444712 - executing: &#34;ExposureMode.SetValue(PySpin.ExposureMode_Timed)&#34;
19444712 - executing: &#34;ExposureAuto.SetValue(PySpin.ExposureAuto_Off)&#34;
19444712 - executing: &#34;ExposureTime.SetValue(60000)&#34;
19444712 - executing: &#34;GainSelector.SetValue(PySpin.GainSelector_All)&#34;
19444712 - executing: &#34;GainAuto.SetValue(PySpin.GainAuto_Off)&#34;
19444712 - executing: &#34;Gain.SetValue(6)&#34;
19444712 - executing: &#34;BlackLevelSelector.SetValue(PySpin.BlackLevelSelector_All)&#34;
19444712 - executing: &#34;BlackLevel.SetValue(0)&#34;
19444712 - executing: &#34;GammaEnable.SetValue(True)&#34;
/home/john/github/FLIR_pubsub/nbs/common/19444715.yaml
19444715 - setting up...
19444715 - executing: &#34;UserSetSelector.SetValue(PySpin.UserSetDefault_Default)&#34;
19444715 - executing: &#34;UserSetLoad.Execute()&#34;
19444715 - executing: &#34;LineSelector.SetValue(PySpin.LineSelector_Line2)&#34;
19444715 - executing: &#34;V3_3Enable.SetValue(True)&#34;
19444715 - executing: &#34;AcquisitionFrameRateEnable.SetValue(False)&#34;
19444715 - executing: &#34;ExposureMode.SetValue(PySpin.ExposureMode_Timed)&#34;
19444715 - executing: &#34;ExposureAuto.SetValue(PySpin.ExposureAuto_Off)&#34;
19444715 - executing: &#34;ExposureTime.SetValue(60000)&#34;
19444715 - executing: &#34;GainSelector.SetValue(PySpin.GainSelector_All)&#34;
19444715 - executing: &#34;GainAuto.SetValue(PySpin.GainAuto_Off)&#34;
19444715 - executing: &#34;Gain.SetValue(6)&#34;
19444715 - executing: &#34;BlackLevelSelector.SetValue(PySpin.BlackLevelSelector_All)&#34;
19444715 - executing: &#34;BlackLevel.SetValue(0)&#34;
19444715 - executing: &#34;GammaEnable.SetValue(True)&#34;
Starting : FrontRight
Starting : FrontLeft
Spinnaker: The current pixel format is not supported. Please convert the image to a supported format. [-1003]
Stopping FrontRight due to inactivity.
Stopping FrontLeft due to inactivity.
Starting : FrontLeft
Starting : FrontRight
stopping FrontRight
stopping FrontLeft
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Commands">Commands<a class="anchor-link" href="#Commands">&#182;</a></h3><p>To quit a terminal session press <code>CNTR+C</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Camera-yaml-files">Camera yaml files<a class="anchor-link" href="#Camera-yaml-files">&#182;</a></h3><p>The server polls all installed cameras and trys to match them with corresponding yaml files
Each camera should have a yaml file with the serial number as its file name
The first 3 entries determine serial number and camera name identifiers, and the link encoding of jpeg or not.<br>
The init section contains the FLIR camera initialisation settings and follows pyspin naming conventions.</p>
<p><strong>19312753.yaml</strong></p>
<div class="highlight"><pre><span></span><span class="nt">serial</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">19312753</span> 
<span class="nt">name</span><span class="p">:</span> <span class="s">&#39;FrontRight&#39;</span>  
<span class="nt">encoding</span><span class="p">:</span> <span class="s">&#39;.jpg&#39;</span>  <span class="c1"># either null or &#39;.jpg&#39;</span>
<span class="nt">init</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">AcquisitionFrameRateEnable</span><span class="p">:</span>
        <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
    <span class="p p-Indicator">-</span> <span class="nt">AcquisitionFrameRate</span><span class="p">:</span>
        <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="c1">#    - BinningHorizontal:</span>
<span class="c1">#        value: 1</span>
<span class="c1">#    - BinningVertical:</span>
<span class="c1">#        value: 1</span>
<span class="c1">#    - ExposureMode:</span>
<span class="c1">#        value: PySpin.ExposureMode_Timed</span>
    <span class=" -Error"> </span><span class="p p-Indicator">-</span> <span class="nt">ExposureAuto</span><span class="p">:</span>
         <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PySpin.ExposureAuto_Continuous</span>
<span class="c1">#     - ExposureTime:</span>
<span class="c1">#         value: 60000</span>
     <span class="p p-Indicator">-</span> <span class="nt">GainSelector</span><span class="p">:</span>
         <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PySpin.GainSelector_All</span>
     <span class="p p-Indicator">-</span> <span class="nt">GainAuto</span><span class="p">:</span>
         <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PySpin.GainAuto_Off</span>
     <span class="p p-Indicator">-</span> <span class="nt">Gain</span><span class="p">:</span>
         <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">6</span>
     <span class="p p-Indicator">-</span> <span class="nt">BlackLevelSelector</span><span class="p">:</span>
         <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PySpin.BlackLevelSelector_All</span>
     <span class="p p-Indicator">-</span> <span class="nt">BlackLevel</span><span class="p">:</span>
         <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
     <span class="p p-Indicator">-</span> <span class="nt">GammaEnable</span><span class="p">:</span>
         <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
</pre></div>
<p>if you wish to trigger the camera with a hardware digital signal then the following should be used</p>
<div class="highlight"><pre><span></span><span class="nt">init</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">TriggerMode</span><span class="p">:</span>  
        <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PySpin.TriggerMode_On</span>  
    <span class="p p-Indicator">-</span> <span class="nt">TriggerSource</span><span class="p">:</span>
        <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PySpin.TriggerSource_Line3</span>
    <span class="p p-Indicator">-</span> <span class="nt">TriggerOverlap</span><span class="p">:</span>
        <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PySpin.TriggerOverlap_ReadOut</span>
    <span class="p p-Indicator">-</span> <span class="nt">TriggerMode</span><span class="p">:</span>
        <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PySpin.TriggerMode_On</span>
    <span class="p p-Indicator">-</span> <span class="nt">AcquisitionFrameRateEnable</span><span class="p">:</span>
        <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">False</span>
</pre></div>
<h2 id="Service-Installation">Service Installation<a class="anchor-link" href="#Service-Installation">&#182;</a></h2><p>The server python file <strong>FLIR-server.py</strong>  polls all available cameras and configures them against the yaml file.</p>

<pre><code>from FLIR_pubsub import FLIR_server_utils
FLIR_server_utils.register()  

from pathlib import Path
if __name__== "__main__":

    yaml_dir= Path.cwd()/'common'
    FLIR_server_utils.server(yaml_dir)</code></pre>
<p>The server <code>FLIR-server.py</code>  requires python &gt; 3.6.<br>
 Install the following prerequisites</p>

<pre><code>sudo apt install python3-opencv
pip install opencv-contrib-python
pip install imutils
pip install PyYAML
pip install zmq</code></pre>
<p>The server <strong>FLIR-server.py</strong> is typically run as a service <strong>flir-server.service</strong>.<br>
To install the service<br>
<code>sudo cp flir-server.service /etc/systemd/system/flir-server.service</code></p>
<h3 id="Service-Control">Service Control<a class="anchor-link" href="#Service-Control">&#182;</a></h3><p>The service can be started and stopped with the following bash commands</p>
<p><code>sudo systemctl start flir-server.service</code><br>
<code>sudo systemctl stop flir-server.service</code></p>
<p>To ensure it runs on boot enable the service</p>
<p><code>sudo systemctl enable flir-server.service</code></p>

</div>
</div>
</div>
</div>
 

